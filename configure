#!/bin/sh

do_help() {
	echo
	echo "--config-dir <dir>	Default config directory."
	echo
	echo "Optional features:"
	echo "  --enable-ansi		enable ansi"
	echo "  --enable-termcap	enable termcap"
	echo "  --enable-terminfo	enable terminfo"
	echo "  --enable-comment-bold	bold comments for C code"
	echo "  --enable-shell	enable shell commands"
	echo "  --enable-spell	enable spell checking"
	echo "  --enable-tags		ctags/etags support"
	echo "  --enable-undo		EXPERIMNETAL undo"
	echo
	echo "Meta-features:"
	echo "  --enable-minconfig	disable everything"
	echo "  --enable-maxconfig	enable everything"
	echo
	echo "To disable a feature replace --enable with --disable."
	echo "Disabling a meta-feature is a NOP."

	exit 0
}

rm -f configure.h
touch configure.h

while [ -n "$1" ]; do
	case "$1" in
	--enable-*) enable=1;;
	--disable-*) enable=0;;
	--config-dir) ;;
	--help) do_help;;
	*) echo "Unknown arg '$1' ignored"; shift; continue;;
	esac

	case "$1" in
	*-ansi) ansi=$enable;;
	*-termcap) termcap=$enable;;
	*-terminfo) terminfo=$enable;;
	*-minconfig) minconfig=$enable;;
	*-maxconfig) maxconfig=$enable;;
	*-comment-bold) comment=$enable;;
	*-undo) undo=$enable;;
	*-shell) shell=$enable;;
	*-tags) tags=$enable;;
	--config-dir) shift; confdir=$1;;
	*) echo "Unknown arg '$1' ignored";;
	esac

	shift
done

if [ "$minconfig" = 1 ]; then
	comment=0; undo=0; shell=0; spell=0; tags=0
elif [ "$maxconfig" = 1 ]; then
	comment=1; undo=1; shell=1; spell=1; tags=1
fi

if [ "$ansi" = 1 ]; then
    terminfo=0; termcap=0
elif [ "$termcap" = 1 ]; then
    ansi=0; terminfo=0
elif [ "$terminfo" = 1 ]; then
    ansi=0; termcap=0
fi

# FreeBSD does not support sed -i
set_one() {
    [ -n "$2" ] || return
    echo "#undef $1" >> configure.h
    echo "#define $1 $2" >> configure.h
}

[ -n "$confdir" ] && echo "#define CONFIGDIR \"$confdir\"" >> configure.h

set_one ANSI $ansi
set_one TERMCAP $termcap
set_one TERMINFO $terminfo

set_one COMMENTBOLD $comment
set_one UNDO $undo

set_one SHELL $shell
set_one TAGS  $tags

auto_detect() {
    echo "/* Generated by configure `date` */" > configure.h
    [ -f /usr/include/sys/poll.h ] && echo "#define HAVE_POLL" >> configure.h

    if [ -f /usr/include/termios.h ]; then
	echo "#define HAVE_TERMIOS" >> configure.h
    elif [ -f /usr/include/termio.h ]; then
	echo "#define HAVE_TERMIO" >> configure.h
    elif [ -f /usr/include/sgtty.h ]; then
	echo "#define HAVE_SGTTY" >> configure.h
    else
	echo "WARNING: No terminal setup found."
    fi

    [ -f /usr/include/dirent.h ] || echo "#define HAVE_DIRECT 1" >> configure.h
}

case `uname -s` in
  Linux) ;;
  FreeBSD) ;;
  *BSD) ;; # untested
  *) auto-detect;;
esac
